<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pluvi√¥metro Digital</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        input, button, select, textarea { font-size: 16px; }
        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-slide { animation: slideIn 0.25s ease both; }
        .spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,0.4); border-top-color:#fff; border-radius:50%; animation: spin 0.7s linear infinite; }
        .toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:#1e293b; color:#fff; padding:10px 20px; border-radius:12px; z-index:999; font-size:14px; font-weight:600; box-shadow:0 4px 20px rgba(0,0,0,0.3); animation: slideIn 0.3s ease both; }
        ::-webkit-scrollbar { width:4px; } ::-webkit-scrollbar-track { background:#f1f5f9; } ::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:2px; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
<div id="root"></div>

<script type="text/babel" data-type="module">
import React, { useState, useEffect, useCallback, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import { 
    CloudRain, Thermometer, MapPin, AlertTriangle, BarChart3, 
    History, Save, Trash2, Wind, CloudLightning, Droplets, 
    Menu, X, Search, Download, Upload, FileText, Cloud, 
    Globe, RefreshCw, CheckCircle, AlertCircle, Database,
    Printer, ChevronDown, Filter, Calendar, ArrowUpDown,
    Wifi, WifiOff, Clock, TrendingUp, TrendingDown, Minus
} from 'lucide-react';

// ========================
// DADOS HIST√ìRICOS SIMULADOS
// ========================
const MOCK_HISTORICAL_DATA = {
    1: { rain: 180, temp: 28, risk: "Enchentes" },
    2: { rain: 150, temp: 28, risk: "Tempestades El√©tricas" },
    3: { rain: 120, temp: 26, risk: null },
    4: { rain: 90, temp: 24, risk: null },
    5: { rain: 80, temp: 20, risk: "Vendavais" },
    6: { rain: 60, temp: 18, risk: "Geada" },
    7: { rain: 70, temp: 17, risk: "Geada/Granizo" },
    8: { rain: 80, temp: 19, risk: "Ventos Fortes" },
    9: { rain: 110, temp: 21, risk: "Granizo" },
    10: { rain: 140, temp: 23, risk: "Tornados/Vendavais" },
    11: { rain: 130, temp: 25, risk: null },
    12: { rain: 160, temp: 27, risk: "Enchentes Rel√¢mpago" },
};

const PHENOMENA_OPTIONS = [
    { id: 'none', label: 'Nenhum', icon: null },
    { id: 'gale', label: 'Vendaval', icon: Wind },
    { id: 'hail', label: 'Granizo', icon: CloudRain },
    { id: 'tornado', label: 'Tornado', icon: AlertTriangle },
    { id: 'flood', label: 'Enchente', icon: Droplets },
    { id: 'storm', label: 'Tempestade', icon: CloudLightning },
];

// ========================
// UTILIT√ÅRIOS
// ========================
const generateId = () => Date.now() + Math.random().toString(36).substr(2,5);

const formatDate = (dateStr) => {
    if (!dateStr) return '-';
    const [y,m,d] = dateStr.split('-');
    return `${d}/${m}/${y}`;
};

const downloadBlob = (blob, filename) => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(() => URL.revokeObjectURL(url), 100);
};

const parseCSV = (text) => {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g,''));
    return lines.slice(1).map(line => {
        const values = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || line.split(',');
        const obj = {};
        headers.forEach((h, i) => {
            obj[h] = (values[i] || '').toString().trim().replace(/"/g,'');
        });
        return obj;
    }).filter(r => r.date && r.rain !== undefined);
};

// ========================
// COMPONENTES BASE
// ========================
const Card = ({ children, className = "" }) => (
    <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
        {children}
    </div>
);

const Badge = ({ type, text }) => (
    <span className={`px-2 py-1 rounded-full text-xs font-medium border ${
        type === 'danger' ? "bg-red-100 text-red-700 border-red-200" : 
        type === 'warning' ? "bg-amber-100 text-amber-700 border-amber-200" :
        type === 'success' ? "bg-green-100 text-green-700 border-green-200" :
        "bg-slate-100 text-slate-700 border-slate-200"
    }`}>{text}</span>
);

const SectionHeader = ({ title, subtitle }) => (
    <div className="mb-4">
        <h2 className="text-lg font-bold text-slate-800">{title}</h2>
        {subtitle && <p className="text-sm text-slate-500">{subtitle}</p>}
    </div>
);

const Modal = ({ open, onClose, title, children }) => {
    if (!open) return null;
    return (
        <div className="fixed inset-0 z-50 flex items-end justify-center md:items-center px-0 md:px-4">
            <div className="absolute inset-0 bg-black/60" onClick={onClose}/>
            <div className="relative bg-white w-full md:max-w-lg rounded-t-2xl md:rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto animate-slide">
                <div className="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                    <h3 className="font-bold text-slate-800">{title}</h3>
                    <button onClick={onClose} className="p-1 text-slate-500 hover:text-slate-800"><X size={20}/></button>
                </div>
                <div className="p-4">{children}</div>
            </div>
        </div>
    );
};

const Toast = ({ message, visible }) => {
    if (!visible) return null;
    return <div className="toast">{message}</div>;
};

// ========================
// APP PRINCIPAL
// ========================
function App() {
    const [view, setView] = useState('dashboard');
    const [entries, setEntries] = useState([]);
    const [locationData, setLocationData] = useState({ cep: '', city: '', uf: '', address: '', lat: null, lon: null });
    const [cepInput, setCepInput] = useState('');
    const [loadingCep, setLoadingCep] = useState(false);
    const [menuOpen, setMenuOpen] = useState(false);
    const [deferredPrompt, setDeferredPrompt] = useState(null);
    const [toast, setToast] = useState({ visible: false, message: '' });
    const [climateData, setClimateData] = useState(null);
    const [loadingClimate, setLoadingClimate] = useState(false);

    // Modais
    const [modal, setModal] = useState(null); // 'import', 'export', 'report', 'backup', 'climate'
    
    // Import/Export
    const [importPreview, setImportPreview] = useState([]);
    const [importErrors, setImportErrors] = useState([]);
    const [exportRange, setExportRange] = useState({ from: '', to: '' });
    
    // Backup
    const [backupConfig, setBackupConfig] = useState(() => {
        try { return JSON.parse(localStorage.getItem('pluviometro_backup') || '{"type":"download","auto":false,"interval":"daily","lastBackup":null,"gasUrl":""}'); }
        catch { return { type: 'download', auto: false, interval: 'daily', lastBackup: null, gasUrl: '' }; }
    });
    const [cloudStatus, setCloudStatus] = useState(null); // null | 'sending' | 'ok' | 'error'
    const [gasUrlInput, setGasUrlInput] = useState(() => {
        try { return JSON.parse(localStorage.getItem('pluviometro_backup') || '{}').gasUrl || ''; } catch { return ''; }
    });

    // Relat√≥rio
    const [reportFilter, setReportFilter] = useState({ month: '', year: new Date().getFullYear().toString(), type: 'monthly' });

    const [formData, setFormData] = useState({
        date: new Date().toISOString().split('T')[0],
        time: new Date().toTimeString().split(' ')[0].slice(0, 5),
        rain: '', temp: '', phenomena: 'none', notes: ''
    });

    const fileInputRef = useRef(null);
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();

    // ============ INIT ============
    useEffect(() => {
        const savedEntries = localStorage.getItem('pluviometro_entries');
        const savedLocation = localStorage.getItem('pluviometro_location');
        if (savedEntries) setEntries(JSON.parse(savedEntries));
        if (savedLocation) {
            const parsed = JSON.parse(savedLocation);
            setLocationData(parsed);
            setCepInput(parsed.cep);
        }
        const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); };
        window.addEventListener('beforeinstallprompt', handler);
        return () => window.removeEventListener('beforeinstallprompt', handler);
    }, []);

    useEffect(() => {
        localStorage.setItem('pluviometro_entries', JSON.stringify(entries));
    }, [entries]);

    useEffect(() => {
        localStorage.setItem('pluviometro_backup', JSON.stringify(backupConfig));
    }, [backupConfig]);

    // Auto backup
    useEffect(() => {
        if (!backupConfig.auto) return;
        const interval = setInterval(() => {
            const last = backupConfig.lastBackup ? new Date(backupConfig.lastBackup) : null;
            const now = new Date();
            const shouldBackup = !last || (
                backupConfig.interval === 'daily' && (now - last) > 86400000 ||
                backupConfig.interval === 'weekly' && (now - last) > 604800000
            );
            if (shouldBackup) executeBackup(true);
        }, 60000);
        return () => clearInterval(interval);
    }, [backupConfig, entries]);

    // ============ HELPERS ============
    const showToast = (message) => {
        setToast({ visible: true, message });
        setTimeout(() => setToast({ visible: false, message: '' }), 2500);
    };

    const navTo = (v) => { setView(v); setMenuOpen(false); };

    // ============ CEP ============
    const handleCepSearch = async () => {
        if (cepInput.length !== 8) { showToast("‚ùå CEP inv√°lido"); return; }
        setLoadingCep(true);
        try {
            const r = await fetch(`https://viacep.com.br/ws/${cepInput}/json/`);
            const data = await r.json();
            if (data.erro) { showToast("‚ùå CEP n√£o encontrado"); return; }
            const newLoc = { cep: cepInput, city: data.localidade, uf: data.uf, address: data.logradouro, lat: null, lon: null };
            // Tenta geocoding
            try {
                const geoR = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(data.localidade)}&state=${data.uf}&country=Brazil&format=json&limit=1`);
                const geo = await geoR.json();
                if (geo[0]) { newLoc.lat = parseFloat(geo[0].lat); newLoc.lon = parseFloat(geo[0].lon); }
            } catch {}
            setLocationData(newLoc);
            localStorage.setItem('pluviometro_location', JSON.stringify(newLoc));
            showToast(`‚úÖ ${data.localidade} - ${data.uf}`);
        } catch { showToast("‚ùå Erro ao buscar CEP"); }
        finally { setLoadingCep(false); }
    };

    // ============ ENTRY ============
    const handleSubmitEntry = (e) => {
        e.preventDefault();
        if (!locationData.city) { showToast("‚ö†Ô∏è Configure sua localiza√ß√£o primeiro"); setView('settings'); return; }
        if (!formData.rain) { showToast("‚ö†Ô∏è Informe a chuva"); return; }
        const newEntry = {
            id: generateId(),
            ...formData,
            rain: parseFloat(formData.rain) || 0,
            temp: parseFloat(formData.temp) || 0,
            year: parseInt(formData.date.split('-')[0]),
            month: parseInt(formData.date.split('-')[1]),
            location: locationData.city,
            uf: locationData.uf,
        };
        setEntries(prev => [newEntry, ...prev]);
        showToast("‚úÖ Registro salvo!");
        setFormData(prev => ({ ...prev, rain: '', temp: '', phenomena: 'none', notes: '' }));
        setView('dashboard');
    };

    const deleteEntry = (id) => {
        if (!confirm("Excluir este registro?")) return;
        setEntries(prev => prev.filter(e => e.id !== id));
        showToast("üóëÔ∏è Exclu√≠do");
    };

    // ============ INSTALL ============
    const handleInstallClick = async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') setDeferredPrompt(null);
        setMenuOpen(false);
    };

    // ============ CSV IMPORT ============
    const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const text = ev.target.result;
            const rows = parseCSV(text);
            const errors = [];
            const valid = rows.map((row, i) => {
                if (!row.date || !row.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    errors.push(`Linha ${i+2}: data inv√°lida ("${row.date}")`);
                    return null;
                }
                const rain = parseFloat(row.rain);
                if (isNaN(rain)) { errors.push(`Linha ${i+2}: chuva inv√°lida`); return null; }
                return {
                    id: generateId(),
                    date: row.date,
                    time: row.time || '00:00',
                    rain,
                    temp: parseFloat(row.temp) || 0,
                    phenomena: row.phenomena || 'none',
                    notes: row.notes || '',
                    year: parseInt(row.date.split('-')[0]),
                    month: parseInt(row.date.split('-')[1]),
                    location: row.location || locationData.city || 'Importado',
                    uf: row.uf || locationData.uf || '',
                };
            }).filter(Boolean);
            setImportPreview(valid);
            setImportErrors(errors);
        };
        reader.readAsText(file);
        e.target.value = '';
    };

    const confirmImport = () => {
        if (!importPreview.length) return;
        const existing = new Set(entries.map(e => e.date + '_' + e.rain + '_' + e.time));
        const nodup = importPreview.filter(e => !existing.has(e.date + '_' + e.rain + '_' + e.time));
        setEntries(prev => [...nodup, ...prev].sort((a,b) => b.date.localeCompare(a.date)));
        showToast(`‚úÖ ${nodup.length} registros importados`);
        setImportPreview([]);
        setImportErrors([]);
        setModal(null);
    };

    // ============ CSV EXPORT ============
    const exportToCSV = () => {
        let data = [...entries];
        if (exportRange.from) data = data.filter(e => e.date >= exportRange.from);
        if (exportRange.to) data = data.filter(e => e.date <= exportRange.to);
        if (!data.length) { showToast("‚ö†Ô∏è Sem dados no per√≠odo"); return; }
        const headers = ['date','time','rain','temp','phenomena','notes','location','uf'];
        const rows = data.map(e => headers.map(h => `"${(e[h]||'').toString().replace(/"/g,'""')}"`).join(','));
        const csv = [headers.join(','), ...rows].join('\n');
        downloadBlob(new Blob(['\ufeff'+csv], { type: 'text/csv;charset=utf-8' }), `pluviometro_${new Date().toISOString().slice(0,10)}.csv`);
        showToast("‚úÖ CSV exportado!");
        setModal(null);
    };

    const downloadTemplate = () => {
        const csv = 'date,time,rain,temp,phenomena,notes,location,uf\n2024-01-15,08:30,12.5,25.3,none,Chuva fraca,S√£o Paulo,SP\n2024-01-16,14:00,35.2,22.1,storm,Tempestade forte,S√£o Paulo,SP';
        downloadBlob(new Blob([csv], { type: 'text/csv' }), 'modelo_pluviometro.csv');
    };

    // ============ RELAT√ìRIO ============
    const generateReport = () => {
        let filtered = [...entries];
        const yr = parseInt(reportFilter.year);
        if (reportFilter.type === 'monthly' && reportFilter.month) {
            filtered = filtered.filter(e => e.year === yr && e.month === parseInt(reportFilter.month));
        } else if (reportFilter.type === 'annual') {
            filtered = filtered.filter(e => e.year === yr);
        }
        const totalRain = filtered.reduce((a,b) => a + b.rain, 0);
        const avgTemp = filtered.length ? filtered.reduce((a,b) => a + b.temp, 0) / filtered.length : 0;
        const maxRain = filtered.length ? Math.max(...filtered.map(e => e.rain)) : 0;
        const rainyDays = [...new Set(filtered.map(e => e.date))].length;

        const months = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
        const byMonth = months.map((m, i) => ({
            m, idx: i+1,
            total: filtered.filter(e => e.month === i+1).reduce((a,b) => a+b.rain, 0)
        }));

        const printWindow = window.open('', '_blank');
        const periodLabel = reportFilter.type === 'monthly' && reportFilter.month
            ? `${months[parseInt(reportFilter.month)-1]}/${reportFilter.year}`
            : reportFilter.year;

        printWindow.document.write(`<!DOCTYPE html><html lang="pt-BR"><head>
<meta charset="UTF-8"><title>Relat√≥rio Pluviom√©trico - ${periodLabel}</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: Arial, sans-serif; color: #1e293b; padding: 32px; font-size: 13px; }
  .header { text-align:center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #2563eb; }
  .header h1 { font-size: 22px; color: #2563eb; }
  .header p { color: #64748b; margin-top: 4px; }
  .stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 24px; }
  .stat { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 14px; text-align:center; }
  .stat .val { font-size: 22px; font-weight: 700; color: #2563eb; }
  .stat .lbl { font-size: 11px; color: #64748b; margin-top: 2px; }
  h2 { font-size: 14px; font-weight: 700; color: #334155; margin-bottom: 10px; margin-top: 20px; }
  table { width: 100%; border-collapse: collapse; }
  th { background: #2563eb; color: #fff; padding: 8px 10px; text-align:left; font-size:12px; }
  td { padding: 7px 10px; border-bottom: 1px solid #f1f5f9; font-size: 12px; }
  tr:nth-child(even) td { background: #f8fafc; }
  .bar-wrap { height: 60px; display: flex; align-items: flex-end; gap: 4px; }
  .bar-item { flex:1; display:flex; flex-direction:column; align-items:center; }
  .bar { background: #2563eb; border-radius: 3px 3px 0 0; min-height: 2px; width: 100%; }
  .bar-lbl { font-size: 9px; color: #94a3b8; margin-top: 2px; }
  .bar-val { font-size: 9px; color: #334155; font-weight:700; }
  .footer { margin-top: 32px; font-size: 11px; color: #94a3b8; text-align:center; border-top:1px solid #e2e8f0; padding-top: 12px; }
  @media print { .no-print { display:none; } }
</style>
</head><body>
<div class="header">
  <h1>üåßÔ∏è Relat√≥rio Pluviom√©trico</h1>
  <p>Per√≠odo: <strong>${periodLabel}</strong> &nbsp;|&nbsp; Local: <strong>${locationData.city || 'N√£o informado'}${locationData.uf ? ' - '+locationData.uf : ''}</strong></p>
  <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
</div>
<div class="stats">
  <div class="stat"><div class="val">${totalRain.toFixed(1)}</div><div class="lbl">Total (mm)</div></div>
  <div class="stat"><div class="val">${rainyDays}</div><div class="lbl">Dias com chuva</div></div>
  <div class="stat"><div class="val">${maxRain.toFixed(1)}</div><div class="lbl">M√°x. em 1 evento (mm)</div></div>
  <div class="stat"><div class="val">${avgTemp.toFixed(1)}¬∞C</div><div class="lbl">Temp. m√©dia</div></div>
</div>
${reportFilter.type === 'annual' ? `
<h2>üìä Distribui√ß√£o Mensal</h2>
<div class="bar-wrap">${(() => {
  const maxV = Math.max(...byMonth.map(b=>b.total), 1);
  return byMonth.map(b => `<div class="bar-item"><div class="bar-val">${b.total > 0 ? b.total.toFixed(0) : ''}</div><div class="bar" style="height:${Math.max((b.total/maxV)*50, b.total>0?4:2)}px"></div><div class="bar-lbl">${b.m}</div></div>`).join('');
})()}</div>` : ''}
<h2>üìã Detalhamento (${filtered.length} registros)</h2>
<table>
<tr><th>Data</th><th>Hora</th><th>Chuva (mm)</th><th>Temp (¬∞C)</th><th>Fen√¥meno</th><th>Observa√ß√µes</th></tr>
${filtered.sort((a,b)=>b.date.localeCompare(a.date)).map(e=>`<tr><td>${formatDate(e.date)}</td><td>${e.time||'-'}</td><td><strong>${e.rain.toFixed(1)}</strong></td><td>${e.temp||'-'}</td><td>${e.phenomena!=='none'?e.phenomena:'-'}</td><td>${e.notes||'-'}</td></tr>`).join('')}
</table>
<div class="footer">Pluvi√¥metro Digital &nbsp;|&nbsp; Dados registrados pelo usu√°rio</div>
<br/><button class="no-print" onclick="window.print()" style="padding:10px 24px;background:#2563eb;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:700;">üñ®Ô∏è Imprimir / Salvar PDF</button>
</body></html>`);
        printWindow.document.close();
        setModal(null);
    };

    // ============ BACKUP ============
    const executeBackup = async (auto = false) => {
        if (!entries.length) { if (!auto) showToast("‚ö†Ô∏è Sem dados para backup"); return; }
        const data = {
            exportDate: new Date().toISOString(),
            version: '1.0',
            location: locationData,
            totalEntries: entries.length,
            entries
        };

        // Backup local (download)
        if (!auto) {
            const json = JSON.stringify(data, null, 2);
            downloadBlob(new Blob([json], { type: 'application/json' }),
                `backup_pluviometro_${new Date().toISOString().slice(0,10)}.json`);
        }

        // Backup na nuvem via Google Apps Script
        const gasUrl = backupConfig.gasUrl || gasUrlInput;
        if (gasUrl && gasUrl.startsWith('https://script.google.com')) {
            setCloudStatus('sending');
            try {
                const res = await fetch(gasUrl, {
                    method: 'POST',
                    mode: 'no-cors', // GAS exige no-cors
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                // no-cors retorna opaque, ent√£o assumimos sucesso se n√£o lan√ßar erro
                setCloudStatus('ok');
                setTimeout(() => setCloudStatus(null), 4000);
                if (!auto) showToast("‚úÖ Backup enviado para o Google Drive!");
            } catch (err) {
                setCloudStatus('error');
                setTimeout(() => setCloudStatus(null), 5000);
                if (!auto) showToast("‚ùå Falha ao enviar para a nuvem");
            }
        } else if (!auto) {
            showToast("‚úÖ Backup local salvo!");
        }

        const updated = { ...backupConfig, lastBackup: new Date().toISOString(), gasUrl: gasUrl };
        setBackupConfig(updated);
        if (!auto) setModal(null);
    };

    const saveGasUrl = (url) => {
        setGasUrlInput(url);
        setBackupConfig(prev => ({ ...prev, gasUrl: url }));
    };

    const restoreBackup = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                if (!data.entries || !Array.isArray(data.entries)) throw new Error();
                if (confirm(`Restaurar ${data.entries.length} registros? Os dados atuais ser√£o mantidos (sem duplicatas).`)) {
                    const existing = new Set(entries.map(e => e.date+'_'+e.rain+'_'+e.time));
                    const nodup = data.entries.filter(e => !existing.has(e.date+'_'+e.rain+'_'+e.time));
                    setEntries(prev => [...nodup, ...prev]);
                    if (data.location && !locationData.city) {
                        setLocationData(data.location);
                        localStorage.setItem('pluviometro_location', JSON.stringify(data.location));
                    }
                    showToast(`‚úÖ ${nodup.length} registros restaurados`);
                    setModal(null);
                }
            } catch { showToast("‚ùå Arquivo de backup inv√°lido"); }
        };
        reader.readAsText(file);
        e.target.value = '';
    };

    // ============ CLIMA REAL ============
    const fetchClimateData = async () => {
        if (!locationData.lat || !locationData.lon) {
            showToast("‚ö†Ô∏è Configure sua localiza√ß√£o para buscar dados clim√°ticos");
            return;
        }
        setLoadingClimate(true);
        try {
            const today = new Date().toISOString().split('T')[0];
            const past30 = new Date(Date.now() - 30*86400000).toISOString().split('T')[0];
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${locationData.lat}&longitude=${locationData.lon}&daily=precipitation_sum,temperature_2m_max,temperature_2m_min&start_date=${past30}&end_date=${today}&timezone=America/Sao_Paulo`;
            const r = await fetch(url);
            const data = await r.json();
            if (!data.daily) throw new Error();
            const days = data.daily.time.map((date, i) => ({
                date,
                rain: data.daily.precipitation_sum[i] || 0,
                tempMax: data.daily.temperature_2m_max[i] || 0,
                tempMin: data.daily.temperature_2m_min[i] || 0,
            }));
            setClimateData({ days, fetchedAt: new Date().toLocaleString('pt-BR'), source: 'Open-Meteo' });
            setModal('climate');
        } catch {
            showToast("‚ùå Erro ao buscar dados clim√°ticos");
        }
        setLoadingClimate(false);
    };

    // ============ C√ÅLCULOS ============
    const currentMonthData = entries.filter(e => e.month === currentMonth && e.year === currentYear);
    const totalRain = currentMonthData.reduce((acc, c) => acc + c.rain, 0).toFixed(1);
    const risk = MOCK_HISTORICAL_DATA[currentMonth]?.risk;
    const historicalAvg = MOCK_HISTORICAL_DATA[currentMonth]?.rain || 0;
    const rainDiff = parseFloat(totalRain) - historicalAvg;

    // ============ RENDER SIDEBAR ============
    const renderSidebar = () => (
        <div className={`fixed inset-y-0 left-0 transform ${menuOpen ? "translate-x-0" : "-translate-x-full"} md:relative md:translate-x-0 transition duration-200 z-30 w-64 bg-slate-800 text-white p-6 shadow-xl md:shadow-none flex flex-col h-full overflow-y-auto`}>
            <div className="flex justify-between items-center mb-8">
                <h1 className="text-xl font-bold flex items-center gap-2"><CloudRain className="text-blue-400"/>Pluvi√¥metro</h1>
                <button onClick={()=>setMenuOpen(false)} className="md:hidden text-slate-400 hover:text-white"><X/></button>
            </div>
            <nav className="flex-1 space-y-1">
                {[
                    {id:'dashboard', icon:BarChart3, l:'Dashboard'},
                    {id:'entry', icon:Save, l:'Registrar'},
                    {id:'reports', icon:History, l:'Relat√≥rios'},
                    {id:'tools', icon:Database, l:'Ferramentas'},
                    {id:'settings', icon:MapPin, l:'Configura√ß√£o'}
                ].map(i=>(
                    <button key={i.id} onClick={()=>navTo(i.id)} className={`w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-colors ${view===i.id?'bg-blue-600 text-white':'text-slate-300 hover:bg-slate-700 hover:text-white'}`}>
                        <i.icon size={18}/> {i.l}
                    </button>
                ))}
                {deferredPrompt && (
                    <button onClick={handleInstallClick} className="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 mt-4 bg-green-600 hover:bg-green-500 text-white animate-pulse">
                        <Download size={18}/> Instalar App
                    </button>
                )}
            </nav>
            {locationData.city && (
                <div className="mt-auto pt-4 border-t border-slate-700 text-xs text-slate-400">
                    <p className="uppercase font-bold text-slate-500 mb-1">Local</p>
                    <p className="font-medium text-slate-300">{locationData.city}/{locationData.uf}</p>
                    {backupConfig.lastBackup && <p className="mt-1">Backup: {new Date(backupConfig.lastBackup).toLocaleDateString('pt-BR')}</p>}
                </div>
            )}
        </div>
    );

    // ============ DASHBOARD ============
    const renderDashboard = () => (
        <div className="space-y-4 pb-20 md:pb-4 animate-slide">
            <div className="grid grid-cols-2 gap-3">
                <Card className="p-4 border-l-4 border-blue-500 col-span-2 bg-gradient-to-br from-white to-blue-50">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-xs text-slate-500 font-medium uppercase tracking-wide">Chuva do M√™s</p>
                            <h3 className="text-4xl font-bold text-slate-800 mt-1">{totalRain}<span className="text-base font-normal text-slate-500 ml-1">mm</span></h3>
                            <div className="flex items-center gap-2 mt-2">
                                <Badge type="neutral" text={`Hist√≥rico: ${historicalAvg}mm`}/>
                                {rainDiff > 5 ? <Badge type="warning" text={`+${rainDiff.toFixed(0)}mm`}/> :
                                 rainDiff < -5 ? <Badge type="neutral" text={`${rainDiff.toFixed(0)}mm`}/> :
                                 <Badge type="success" text="Normal"/>}
                            </div>
                        </div>
                        <div className="p-3 bg-blue-100 rounded-full text-blue-600"><CloudRain size={24}/></div>
                    </div>
                </Card>
                <Card className="p-4 border-l-4 border-amber-500">
                    <p className="text-xs text-slate-500 font-medium uppercase tracking-wide mb-1">Alerta</p>
                    {risk ? (
                        <div className="flex items-center gap-1.5 text-amber-600 font-bold text-sm"><AlertTriangle size={14}/>{risk}</div>
                    ) : <p className="text-green-600 font-bold text-sm">Normal ‚úì</p>}
                </Card>
                <Card className="p-4 border-l-4 border-slate-400">
                    <p className="text-xs text-slate-500 font-medium uppercase tracking-wide mb-1">Registros</p>
                    <p className="text-2xl font-bold text-slate-800">{currentMonthData.length}<span className="text-xs font-normal text-slate-400 ml-1">este m√™s</span></p>
                </Card>
            </div>

            <Card>
                <div className="flex justify-between items-center p-4 border-b bg-slate-50">
                    <span className="font-bold text-slate-700 text-sm">√öltimos Registros</span>
                    <button onClick={()=>navTo('reports')} className="text-blue-500 text-xs font-medium">Ver todos ‚Üí</button>
                </div>
                {entries.slice(0,5).map(e=>(
                    <div key={e.id} className="p-3 border-b flex justify-between items-center hover:bg-slate-50 transition-colors">
                        <div>
                            <p className="text-sm font-medium">{formatDate(e.date)} {e.time && <span className="text-xs text-slate-400">{e.time}</span>}</p>
                            <p className="text-xs text-slate-400">{e.location}</p>
                        </div>
                        <div className="text-right">
                            <p className="font-bold text-blue-600">{e.rain}mm</p>
                            {e.temp > 0 && <p className="text-xs text-slate-400">{e.temp}¬∞C</p>}
                        </div>
                    </div>
                ))}
                {entries.length === 0 && (
                    <div className="p-8 text-center text-slate-400">
                        <CloudRain className="mx-auto mb-2 opacity-30" size={32}/>
                        <p className="text-sm">Sem dados. Comece registrando!</p>
                    </div>
                )}
            </Card>

            <div className="grid grid-cols-2 gap-3">
                <button onClick={()=>setModal('export')} className="p-4 bg-white rounded-xl border border-slate-200 shadow-sm flex items-center gap-2 text-sm font-medium text-slate-700 hover:bg-slate-50 active:scale-95 transition-transform">
                    <Download size={18} className="text-blue-500"/> Exportar CSV
                </button>
                <button onClick={()=>setModal('report')} className="p-4 bg-white rounded-xl border border-slate-200 shadow-sm flex items-center gap-2 text-sm font-medium text-slate-700 hover:bg-slate-50 active:scale-95 transition-transform">
                    <Printer size={18} className="text-green-500"/> Relat√≥rio
                </button>
                <button onClick={fetchClimateData} disabled={loadingClimate} className="p-4 bg-white rounded-xl border border-slate-200 shadow-sm flex items-center gap-2 text-sm font-medium text-slate-700 hover:bg-slate-50 active:scale-95 transition-transform">
                    {loadingClimate ? <div className="spinner border-slate-400 border-t-blue-500"/> : <Globe size={18} className="text-purple-500"/>} Clima Real
                </button>
                <button onClick={()=>setModal('backup')} className="p-4 bg-white rounded-xl border border-slate-200 shadow-sm flex items-center gap-2 text-sm font-medium text-slate-700 hover:bg-slate-50 active:scale-95 transition-transform">
                    <Cloud size={18} className="text-sky-500"/> Backup
                </button>
            </div>
        </div>
    );

    // ============ ENTRY ============
    const renderEntry = () => (
        <div className="max-w-xl mx-auto space-y-4 pb-20 animate-slide">
            <Card className="p-5">
                <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800"><Save className="text-blue-600" size={20}/>Registrar Leitura</h2>
                <form onSubmit={handleSubmitEntry} className="space-y-4">
                    <div className="grid grid-cols-2 gap-3">
                        <div>
                            <label className="text-xs text-slate-500 font-medium mb-1 block">Data</label>
                            <input type="date" required className="w-full border border-slate-300 p-2.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})}/>
                        </div>
                        <div>
                            <label className="text-xs text-slate-500 font-medium mb-1 block">Hora</label>
                            <input type="time" required className="w-full border border-slate-300 p-2.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})}/>
                        </div>
                    </div>
                    <div>
                        <label className="text-xs text-slate-500 font-medium mb-1 block">Precipita√ß√£o (mm) *</label>
                        <input type="number" step="0.1" min="0" placeholder="Ex: 12.5" required className="w-full border-2 border-blue-300 p-3 rounded-lg text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-400" value={formData.rain} onChange={e=>setFormData({...formData, rain:e.target.value})}/>
                    </div>
                    <div>
                        <label className="text-xs text-slate-500 font-medium mb-1 block">Temperatura (¬∞C)</label>
                        <input type="number" step="0.1" placeholder="Ex: 25.0" className="w-full border border-slate-300 p-2.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" value={formData.temp} onChange={e=>setFormData({...formData, temp:e.target.value})}/>
                    </div>
                    <div>
                        <label className="text-xs text-slate-500 font-medium mb-1 block">Fen√¥meno</label>
                        <div className="grid grid-cols-3 gap-2">
                            {PHENOMENA_OPTIONS.map(p=>(
                                <button type="button" key={p.id} onClick={()=>setFormData({...formData, phenomena:p.id})}
                                    className={`p-2.5 border-2 rounded-lg flex flex-col items-center text-xs font-medium transition-colors ${formData.phenomena===p.id?'bg-blue-50 border-blue-500 text-blue-700':'border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                                    {p.icon && <p.icon size={16} className="mb-1"/>}{p.label}
                                </button>
                            ))}
                        </div>
                    </div>
                    <div>
                        <label className="text-xs text-slate-500 font-medium mb-1 block">Observa√ß√µes</label>
                        <textarea rows={2} placeholder="Notas opcionais..." className="w-full border border-slate-300 p-2.5 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-400" value={formData.notes} onChange={e=>setFormData({...formData, notes:e.target.value})}/>
                    </div>
                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white p-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
                        SALVAR REGISTRO
                    </button>
                </form>
            </Card>
        </div>
    );

    // ============ REPORTS ============
    const renderReports = () => {
        const months = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
        const barData = months.map((m,i) => {
            const current = entries.filter(e=>e.month===i+1 && e.year===currentYear).reduce((a,b)=>a+b.rain, 0);
            return { m, v: current, h: MOCK_HISTORICAL_DATA[i+1]?.rain || 0 };
        });
        const max = Math.max(...barData.map(d=>Math.max(d.v, d.h)), 50);
        return (
            <div className="pb-20 space-y-4 animate-slide">
                <div className="flex gap-2 justify-end">
                    <button onClick={()=>setModal('report')} className="flex items-center gap-1 bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium active:scale-95 transition-transform">
                        <Printer size={14}/> Gerar Relat√≥rio
                    </button>
                    <button onClick={()=>setModal('export')} className="flex items-center gap-1 bg-slate-700 text-white px-3 py-2 rounded-lg text-sm font-medium active:scale-95 transition-transform">
                        <Download size={14}/> Exportar CSV
                    </button>
                </div>
                <Card className="p-4">
                    <h3 className="font-bold mb-1 text-slate-800">Chuva {currentYear}</h3>
                    <p className="text-xs text-slate-400 mb-3 flex items-center gap-3">
                        <span className="flex items-center gap-1"><span className="w-3 h-2 bg-blue-500 rounded-sm inline-block"/> Seus dados</span>
                        <span className="flex items-center gap-1"><span className="w-3 h-2 bg-slate-200 rounded-sm inline-block"/> Hist√≥rico</span>
                    </p>
                    <div className="h-32 flex items-end gap-0.5">
                        {barData.map((d,i)=>{
                            const maxH = Math.max(d.h/max*100, 2);
                            const maxV = Math.max(d.v/max*100, d.v > 0 ? 2 : 0);
                            return (
                                <div key={i} className="flex-1 flex flex-col items-center justify-end h-full">
                                    <div className="flex items-end gap-[1px] h-full justify-center w-full">
                                        <div style={{height:`${maxH}%`}} className="flex-1 bg-slate-200 rounded-t-sm min-h-0"/>
                                        <div style={{height:`${maxV}%`}} className="flex-1 bg-blue-500 rounded-t-sm min-h-0"/>
                                    </div>
                                    <span className="text-[9px] text-slate-400 mt-1 leading-none">{d.m}</span>
                                </div>
                            );
                        })}
                    </div>
                </Card>
                <Card>
                    <div className="bg-slate-50 p-3 font-bold text-sm border-b text-slate-700 flex justify-between items-center">
                        <span>Hist√≥rico de Registros</span>
                        <Badge type="neutral" text={`${entries.length} total`}/>
                    </div>
                    {entries.length === 0 && (
                        <div className="p-8 text-center text-slate-400 text-sm">Nenhum registro ainda</div>
                    )}
                    {entries.slice().sort((a,b)=>b.date.localeCompare(a.date)).map(e=>(
                        <div key={e.id} className="p-3 border-b flex justify-between items-center hover:bg-slate-50">
                            <div>
                                <p className="text-sm font-medium">{formatDate(e.date)} <span className="text-xs text-slate-400">{e.time}</span></p>
                                <p className="text-xs text-slate-400">{e.location}{e.uf ? ` - ${e.uf}` : ''}</p>
                                {e.phenomena !== 'none' && <Badge type="warning" text={e.phenomena}/>}
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="text-right">
                                    <p className="font-bold text-blue-600">{e.rain}mm</p>
                                    {e.temp > 0 && <p className="text-xs text-slate-400">{e.temp}¬∞C</p>}
                                </div>
                                <button onClick={()=>deleteEntry(e.id)} className="text-red-300 hover:text-red-500 p-1"><Trash2 size={14}/></button>
                            </div>
                        </div>
                    ))}
                </Card>
            </div>
        );
    };

    // ============ FERRAMENTAS ============
    const renderTools = () => (
        <div className="space-y-4 pb-20 animate-slide">
            <SectionHeader title="Ferramentas" subtitle="Importa√ß√£o, exporta√ß√£o, backup e dados clim√°ticos"/>

            {/* IMPORTAR CSV */}
            <Card className="p-4">
                <div className="flex items-start gap-3 mb-3">
                    <div className="p-2 bg-green-100 rounded-lg"><Upload size={18} className="text-green-600"/></div>
                    <div>
                        <h3 className="font-bold text-slate-800">Importar CSV</h3>
                        <p className="text-xs text-slate-500">Carregue dados de um arquivo CSV</p>
                    </div>
                </div>
                <div className="space-y-2">
                    <button onClick={downloadTemplate} className="w-full text-blue-600 border border-blue-200 bg-blue-50 p-2.5 rounded-lg text-sm font-medium text-left flex items-center gap-2 active:scale-95 transition-transform">
                        <FileText size={14}/> Baixar modelo CSV
                    </button>
                    <button onClick={()=>setModal('import')} className="w-full bg-green-600 text-white p-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
                        <Upload size={14}/> Selecionar arquivo CSV
                    </button>
                </div>
            </Card>

            {/* EXPORTAR CSV */}
            <Card className="p-4">
                <div className="flex items-start gap-3 mb-3">
                    <div className="p-2 bg-blue-100 rounded-lg"><Download size={18} className="text-blue-600"/></div>
                    <div>
                        <h3 className="font-bold text-slate-800">Exportar CSV</h3>
                        <p className="text-xs text-slate-500">{entries.length} registro(s) dispon√≠veis</p>
                    </div>
                </div>
                <button onClick={()=>setModal('export')} className="w-full bg-blue-600 text-white p-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    <Download size={14}/> Exportar dados
                </button>
            </Card>

            {/* RELAT√ìRIO */}
            <Card className="p-4">
                <div className="flex items-start gap-3 mb-3">
                    <div className="p-2 bg-purple-100 rounded-lg"><Printer size={18} className="text-purple-600"/></div>
                    <div>
                        <h3 className="font-bold text-slate-800">Relat√≥rio para Impress√£o</h3>
                        <p className="text-xs text-slate-500">Gera PDF com dados e gr√°ficos</p>
                    </div>
                </div>
                <button onClick={()=>setModal('report')} className="w-full bg-purple-600 text-white p-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    <Printer size={14}/> Gerar relat√≥rio
                </button>
            </Card>

            {/* BACKUP */}
            <Card className="p-4">
                <div className="flex items-start gap-3 mb-3">
                    <div className="p-2 bg-sky-100 rounded-lg"><Cloud size={18} className="text-sky-600"/></div>
                    <div className="flex-1">
                        <h3 className="font-bold text-slate-800">Backup Google Drive</h3>
                        <p className="text-xs text-slate-500">
                            {backupConfig.gasUrl
                                ? <span className="text-green-600 font-medium">‚òÅÔ∏è Nuvem configurada</span>
                                : 'Configure o Apps Script para backup autom√°tico'}
                        </p>
                        {backupConfig.lastBackup && <p className="text-xs text-slate-400 mt-0.5">√öltimo: {new Date(backupConfig.lastBackup).toLocaleString('pt-BR')}</p>}
                    </div>
                    {backupConfig.auto && backupConfig.gasUrl && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">Auto</span>}
                </div>
                <div className="space-y-2">
                    <div className="flex items-center justify-between p-2.5 bg-slate-50 rounded-lg text-sm">
                        <span className="text-slate-600">Backup autom√°tico</span>
                        <button onClick={()=>setBackupConfig(prev=>({...prev, auto:!prev.auto}))} disabled={!backupConfig.gasUrl} className={`w-10 h-6 rounded-full transition-colors flex items-center disabled:opacity-40 ${backupConfig.auto && backupConfig.gasUrl ? 'bg-blue-500 justify-end' : 'bg-slate-300 justify-start'}`}>
                            <div className="w-4 h-4 bg-white rounded-full shadow m-0.5"/>
                        </button>
                    </div>
                    <button onClick={()=>setModal('backup')} className="w-full bg-sky-600 text-white p-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
                        {cloudStatus === 'sending' ? <><div className="spinner"/> Enviando...</> : <><Cloud size={14}/> Configurar / Fazer Backup</>}
                    </button>
                </div>
            </Card>

            {/* DADOS CLIM√ÅTICOS */}
            <Card className="p-4">
                <div className="flex items-start gap-3 mb-3">
                    <div className="p-2 bg-orange-100 rounded-lg"><Globe size={18} className="text-orange-600"/></div>
                    <div>
                        <h3 className="font-bold text-slate-800">Dados Clim√°ticos Reais</h3>
                        <p className="text-xs text-slate-500">Compare com dados da Open-Meteo API</p>
                    </div>
                </div>
                {!locationData.lat && <p className="text-xs text-amber-600 bg-amber-50 p-2 rounded-lg mb-2">‚ö†Ô∏è Configure sua localiza√ß√£o primeiro</p>}
                <button onClick={fetchClimateData} disabled={loadingClimate || !locationData.lat} className="w-full bg-orange-500 disabled:opacity-50 text-white p-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    {loadingClimate ? <><div className="spinner"/> Buscando...</> : <><Globe size={14}/> Buscar dados reais</>}
                </button>
                {climateData && (
                    <p className="text-xs text-slate-400 mt-2 text-center">√öltima busca: {climateData.fetchedAt} ¬∑ {climateData.source}</p>
                )}
            </Card>
        </div>
    );

    // ============ SETTINGS ============
    const renderSettings = () => (
        <div className="max-w-xl mx-auto pb-20 space-y-4 animate-slide">
            <Card className="p-5 space-y-4">
                <h2 className="font-bold text-lg flex items-center gap-2"><MapPin size={18} className="text-blue-600"/>Localiza√ß√£o</h2>
                <div className="flex gap-2">
                    <input className="border border-slate-300 p-2.5 rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Digite seu CEP (8 d√≠gitos)" maxLength={8} value={cepInput} onChange={e=>setCepInput(e.target.value.replace(/\D/g,''))} onKeyDown={e=>e.key==='Enter'&&handleCepSearch()}/>
                    <button onClick={handleCepSearch} className="bg-blue-600 text-white p-2.5 rounded-lg w-12 flex items-center justify-center active:scale-95 transition-transform">
                        {loadingCep ? <div className="spinner"/> : <Search size={18}/>}
                    </button>
                </div>
                {locationData.city && (
                    <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <p className="font-bold text-slate-800">{locationData.city} - {locationData.uf}</p>
                        <p className="text-sm text-slate-500">{locationData.address}</p>
                        {locationData.lat && <p className="text-xs text-slate-400 mt-1">üìç {locationData.lat.toFixed(4)}, {locationData.lon.toFixed(4)}</p>}
                    </div>
                )}
                {locationData.city && (
                    <div className="h-44 bg-slate-200 rounded-lg overflow-hidden border border-slate-200">
                        <iframe width="100%" height="100%" src={`https://maps.google.com/maps?q=${encodeURIComponent(locationData.city + ',' + locationData.uf)}&t=&z=13&ie=UTF8&iwloc=&output=embed`} frameBorder="0" title="Mapa"/>
                    </div>
                )}
            </Card>

            <Card className="p-5">
                <h2 className="font-bold text-lg flex items-center gap-2 mb-3"><Database size={18} className="text-slate-600"/>Dados</h2>
                <div className="space-y-2">
                    <div className="flex justify-between items-center py-2 border-b">
                        <span className="text-sm text-slate-600">Total de registros</span>
                        <span className="font-bold">{entries.length}</span>
                    </div>
                    <div className="flex justify-between items-center py-2 border-b">
                        <span className="text-sm text-slate-600">Primeiro registro</span>
                        <span className="text-sm">{entries.length ? formatDate(entries.sort((a,b)=>a.date.localeCompare(b.date))[0].date) : '-'}</span>
                    </div>
                    <div className="flex justify-between items-center py-2">
                        <span className="text-sm text-slate-600">√öltimo backup</span>
                        <span className="text-sm">{backupConfig.lastBackup ? new Date(backupConfig.lastBackup).toLocaleDateString('pt-BR') : 'Nunca'}</span>
                    </div>
                    <button onClick={()=>{if(confirm('Apagar todos os dados?'))setEntries([]);}} className="w-full text-red-600 border border-red-200 bg-red-50 p-2.5 rounded-lg text-sm font-medium flex items-center justify-center gap-2 mt-2 active:scale-95 transition-transform">
                        <Trash2 size={14}/> Apagar todos os dados
                    </button>
                </div>
            </Card>
        </div>
    );

    // ============ MODAIS ============

    // Modal Import
    const renderImportModal = () => (
        <Modal open={modal==='import'} onClose={()=>{setModal(null);setImportPreview([]);setImportErrors([]);}} title="üì• Importar CSV">
            <div className="space-y-4">
                <div className="bg-blue-50 p-3 rounded-lg text-sm text-blue-700">
                    <strong>Colunas esperadas:</strong> date (AAAA-MM-DD), time, rain, temp, phenomena, notes, location, uf
                </div>
                <input type="file" ref={fileInputRef} accept=".csv,.txt" onChange={handleFileSelect} className="hidden"/>
                <button onClick={()=>fileInputRef.current?.click()} className="w-full border-2 border-dashed border-blue-300 text-blue-600 p-6 rounded-xl text-center font-medium hover:bg-blue-50 active:scale-95 transition-transform">
                    <Upload className="mx-auto mb-2" size={24}/>
                    Toque para selecionar arquivo CSV
                </button>
                {importErrors.length > 0 && (
                    <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                        <p className="text-red-700 font-medium text-sm mb-1">‚ö†Ô∏è {importErrors.length} erro(s) encontrado(s):</p>
                        {importErrors.slice(0,5).map((err,i)=><p key={i} className="text-xs text-red-600">{err}</p>)}
                    </div>
                )}
                {importPreview.length > 0 && (
                    <div>
                        <p className="text-sm font-medium text-slate-700 mb-2">‚úÖ {importPreview.length} registros prontos para importar:</p>
                        <div className="max-h-40 overflow-y-auto border rounded-lg">
                            {importPreview.slice(0,10).map((r,i)=>(
                                <div key={i} className="flex justify-between p-2 text-xs border-b hover:bg-slate-50">
                                    <span>{formatDate(r.date)} {r.time}</span>
                                    <span className="font-bold text-blue-600">{r.rain}mm</span>
                                </div>
                            ))}
                            {importPreview.length > 10 && <p className="text-xs text-center text-slate-400 p-2">... e mais {importPreview.length-10}</p>}
                        </div>
                        <button onClick={confirmImport} className="w-full mt-3 bg-green-600 text-white p-3 rounded-xl font-bold active:scale-95 transition-transform">
                            Importar {importPreview.length} registros
                        </button>
                    </div>
                )}
                <button onClick={downloadTemplate} className="w-full text-slate-600 border border-slate-200 p-2.5 rounded-lg text-sm font-medium flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    <FileText size={14}/> Baixar modelo CSV
                </button>
            </div>
        </Modal>
    );

    // Modal Export
    const renderExportModal = () => (
        <Modal open={modal==='export'} onClose={()=>setModal(null)} title="üì§ Exportar CSV">
            <div className="space-y-4">
                <p className="text-sm text-slate-600">{entries.length} registro(s) dispon√≠veis. Filtre por per√≠odo (opcional):</p>
                <div className="grid grid-cols-2 gap-3">
                    <div>
                        <label className="text-xs text-slate-500 block mb-1">De:</label>
                        <input type="date" className="w-full border border-slate-300 p-2.5 rounded-lg" value={exportRange.from} onChange={e=>setExportRange(prev=>({...prev, from:e.target.value}))}/>
                    </div>
                    <div>
                        <label className="text-xs text-slate-500 block mb-1">At√©:</label>
                        <input type="date" className="w-full border border-slate-300 p-2.5 rounded-lg" value={exportRange.to} onChange={e=>setExportRange(prev=>({...prev, to:e.target.value}))}/>
                    </div>
                </div>
                <div className="bg-slate-50 p-3 rounded-lg text-sm text-slate-600">
                    Ser√£o exportados: <strong>{(() => {
                        let d = [...entries];
                        if (exportRange.from) d = d.filter(e=>e.date>=exportRange.from);
                        if (exportRange.to) d = d.filter(e=>e.date<=exportRange.to);
                        return d.length;
                    })()} registro(s)</strong>
                </div>
                <button onClick={exportToCSV} className="w-full bg-blue-600 text-white p-3 rounded-xl font-bold active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <Download size={16}/> Baixar CSV
                </button>
            </div>
        </Modal>
    );

    // Modal Report
    const renderReportModal = () => {
        const months = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
        return (
            <Modal open={modal==='report'} onClose={()=>setModal(null)} title="üìÑ Configurar Relat√≥rio">
                <div className="space-y-4">
                    <div>
                        <label className="text-xs text-slate-500 font-medium block mb-1">Tipo de relat√≥rio</label>
                        <select className="w-full border border-slate-300 p-2.5 rounded-lg" value={reportFilter.type} onChange={e=>setReportFilter(prev=>({...prev, type:e.target.value}))}>
                            <option value="monthly">Mensal</option>
                            <option value="annual">Anual</option>
                        </select>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        {reportFilter.type === 'monthly' && (
                            <div>
                                <label className="text-xs text-slate-500 font-medium block mb-1">M√™s</label>
                                <select className="w-full border border-slate-300 p-2.5 rounded-lg" value={reportFilter.month} onChange={e=>setReportFilter(prev=>({...prev, month:e.target.value}))}>
                                    <option value="">Todos</option>
                                    {months.map((m,i)=><option key={i} value={i+1}>{m}</option>)}
                                </select>
                            </div>
                        )}
                        <div>
                            <label className="text-xs text-slate-500 font-medium block mb-1">Ano</label>
                            <input type="number" className="w-full border border-slate-300 p-2.5 rounded-lg" value={reportFilter.year} onChange={e=>setReportFilter(prev=>({...prev, year:e.target.value}))} min="2020" max="2030"/>
                        </div>
                    </div>
                    <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-700">
                        Ser√° gerado um relat√≥rio para impress√£o com tabela detalhada{reportFilter.type === 'annual' ? ', gr√°fico mensal' : ''} e estat√≠sticas do per√≠odo.
                    </div>
                    <button onClick={generateReport} className="w-full bg-purple-600 text-white p-3 rounded-xl font-bold active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <Printer size={16}/> Gerar e Abrir Relat√≥rio
                    </button>
                </div>
            </Modal>
        );
    };

    // Modal Backup
    const renderBackupModal = () => {
        const hasGas = backupConfig.gasUrl && backupConfig.gasUrl.startsWith('https://script.google.com');
        return (
            <Modal open={modal==='backup'} onClose={()=>setModal(null)} title="‚òÅÔ∏è Backup Google Drive">
                <div className="space-y-4">

                    {/* Status cloud */}
                    {cloudStatus === 'sending' && (
                        <div className="flex items-center gap-2 bg-blue-50 text-blue-700 p-3 rounded-lg text-sm font-medium">
                            <div className="spinner border-blue-300 border-t-blue-600"/> Enviando para o Google Drive...
                        </div>
                    )}
                    {cloudStatus === 'ok' && (
                        <div className="flex items-center gap-2 bg-green-50 text-green-700 p-3 rounded-lg text-sm font-medium">
                            <CheckCircle size={16}/> Enviado com sucesso para o Google Drive!
                        </div>
                    )}
                    {cloudStatus === 'error' && (
                        <div className="flex items-center gap-2 bg-red-50 text-red-700 p-3 rounded-lg text-sm font-medium">
                            <AlertCircle size={16}/> Falha ao enviar. Verifique a URL do Apps Script.
                        </div>
                    )}

                    {/* √öltimo backup */}
                    {backupConfig.lastBackup && (
                        <div className="flex items-center gap-2 text-sm text-green-700 bg-green-50 p-3 rounded-lg">
                            <CheckCircle size={14}/> √öltimo backup: {new Date(backupConfig.lastBackup).toLocaleString('pt-BR')}
                        </div>
                    )}

                    {/* URL do Google Apps Script */}
                    <div className="space-y-2">
                        <label className="text-sm font-bold text-slate-700 block">üîó URL do Google Apps Script</label>
                        <input
                            type="url"
                            placeholder="https://script.google.com/macros/s/SEU_ID/exec"
                            className={`w-full border-2 p-2.5 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 ${hasGas ? 'border-green-400 bg-green-50' : 'border-slate-300'}`}
                            value={gasUrlInput}
                            onChange={e => setGasUrlInput(e.target.value)}
                            onBlur={e => saveGasUrl(e.target.value.trim())}
                        />
                        {hasGas
                            ? <p className="text-xs text-green-600 flex items-center gap-1"><CheckCircle size={12}/> URL configurada ‚Äî backup na nuvem ativo</p>
                            : <p className="text-xs text-slate-500">Cole aqui a URL gerada pelo Apps Script (veja instru√ß√µes abaixo)</p>
                        }
                    </div>

                    {/* Auto backup toggle */}
                    <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border">
                        <div>
                            <p className="text-sm font-medium">Backup autom√°tico</p>
                            <p className="text-xs text-slate-500">{hasGas ? 'Envia automaticamente para o Drive' : 'Requer URL do Apps Script'}</p>
                        </div>
                        <button
                            onClick={()=>setBackupConfig(prev=>({...prev, auto:!prev.auto}))}
                            disabled={!hasGas}
                            className={`w-12 h-6 rounded-full transition-colors flex items-center disabled:opacity-40 ${backupConfig.auto && hasGas ? 'bg-blue-500 justify-end' : 'bg-slate-300 justify-start'}`}>
                            <div className="w-5 h-5 bg-white rounded-full shadow m-0.5"/>
                        </button>
                    </div>
                    {backupConfig.auto && hasGas && (
                        <select className="w-full border border-slate-200 p-2.5 rounded-lg text-sm" value={backupConfig.interval} onChange={e=>setBackupConfig(prev=>({...prev, interval:e.target.value}))}>
                            <option value="daily">Diariamente</option>
                            <option value="weekly">Semanalmente</option>
                        </select>
                    )}

                    {/* Bot√µes de a√ß√£o */}
                    <button onClick={()=>executeBackup(false)} className="w-full bg-sky-600 text-white p-3 rounded-xl font-bold active:scale-95 transition-transform flex items-center justify-center gap-2">
                        {hasGas ? <><Cloud size={16}/> Fazer Backup Agora ‚Üí Drive + Local</> : <><Download size={16}/> Fazer Backup Local ({entries.length} registros)</>}
                    </button>

                    {/* Instru√ß√µes */}
                    <details className="border border-slate-200 rounded-lg overflow-hidden">
                        <summary className="p-3 bg-slate-50 text-sm font-medium cursor-pointer text-slate-700 select-none">
                            üìã Como configurar o Google Apps Script
                        </summary>
                        <div className="p-3 space-y-2 text-xs text-slate-600 bg-white">
                            <div className="flex gap-2"><span className="w-5 h-5 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs">1</span><p>Acesse <strong>script.google.com</strong> e clique em <strong>"Novo projeto"</strong></p></div>
                            <div className="flex gap-2"><span className="w-5 h-5 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs">2</span><p>Apague o c√≥digo existente e cole o conte√∫do do arquivo <strong>backup_script.gs</strong> fornecido</p></div>
                            <div className="flex gap-2"><span className="w-5 h-5 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs">3</span><p>Clique em <strong>"Implantar" ‚Üí "Nova implanta√ß√£o"</strong></p></div>
                            <div className="flex gap-2"><span className="w-5 h-5 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs">4</span><p>Tipo: <strong>App da Web</strong> ¬∑ Executar como: <strong>Eu</strong> ¬∑ Acesso: <strong>Qualquer pessoa</strong></p></div>
                            <div className="flex gap-2"><span className="w-5 h-5 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs">5</span><p>Clique em <strong>"Implantar"</strong>, autorize o acesso e copie a <strong>URL do app da Web</strong></p></div>
                            <div className="flex gap-2"><span className="w-5 h-5 bg-green-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs">‚úì</span><p>Cole a URL no campo acima. Pronto! Os backups ser√£o salvos na pasta <strong>"Pluvi√¥metro Backups"</strong> no seu Drive e na planilha do projeto.</p></div>
                        </div>
                    </details>

                    {/* Restaurar */}
                    <div className="border-t pt-3">
                        <p className="text-sm font-medium text-slate-700 mb-2">Restaurar Backup Local</p>
                        <input type="file" accept=".json" onChange={restoreBackup} className="hidden" id="backup-restore-file"/>
                        <label htmlFor="backup-restore-file" className="w-full border-2 border-dashed border-slate-300 text-slate-600 p-3 rounded-xl text-center text-sm font-medium block cursor-pointer hover:bg-slate-50 active:scale-95 transition-transform">
                            <Upload className="mx-auto mb-1" size={18}/>
                            Selecionar arquivo .json para restaurar
                        </label>
                    </div>
                </div>
            </Modal>
        );
    };

    // Modal Clima
    const renderClimateModal = () => {
        if (!climateData) return null;
        const myDates = new Set(entries.map(e => e.date));
        const months = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
        const myRainByDate = {};
        entries.forEach(e => { myRainByDate[e.date] = (myRainByDate[e.date]||0)+e.rain; });
        const last14 = climateData.days.slice(-14);
        return (
            <Modal open={modal==='climate'} onClose={()=>setModal(null)} title="üåê Dados Clim√°ticos Reais">
                <div className="space-y-4">
                    <div className="bg-orange-50 p-3 rounded-lg text-xs text-orange-700">
                        Fonte: <strong>Open-Meteo.com</strong> ¬∑ Busca: {climateData.fetchedAt} ¬∑ Local: {locationData.city}
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-center">
                        {[
                            { label: 'Total 30d (API)', value: `${climateData.days.reduce((a,b)=>a+b.rain,0).toFixed(1)}mm` },
                            { label: 'Total 30d (Meus)', value: `${Object.values(myRainByDate).reduce((a,b)=>a+b,0).toFixed(1)}mm` },
                            { label: 'Dias com chuva', value: climateData.days.filter(d=>d.rain>0).length },
                        ].map((s,i)=>(
                            <div key={i} className="bg-slate-50 rounded-lg p-3 border">
                                <p className="text-base font-bold text-slate-800">{s.value}</p>
                                <p className="text-xs text-slate-500 mt-0.5">{s.label}</p>
                            </div>
                        ))}
                    </div>
                    <h4 className="text-sm font-bold text-slate-700">√öltimos 14 dias ‚Äî Compara√ß√£o</h4>
                    <div className="space-y-1 max-h-72 overflow-y-auto">
                        <div className="grid grid-cols-5 text-xs text-slate-400 font-medium pb-1 border-b px-2">
                            <span className="col-span-2">Data</span>
                            <span>API</span>
                            <span>Meu</span>
                            <span>Diff</span>
                        </div>
                        {last14.slice().reverse().map((day, i) => {
                            const mine = myRainByDate[day.date] || 0;
                            const diff = mine - day.rain;
                            const d = new Date(day.date + 'T12:00:00');
                            return (
                                <div key={i} className={`grid grid-cols-5 text-xs p-2 rounded ${myDates.has(day.date) ? 'bg-blue-50' : 'hover:bg-slate-50'}`}>
                                    <span className="col-span-2 text-slate-600">{d.getDate()} {months[d.getMonth()]}</span>
                                    <span className="font-medium">{day.rain.toFixed(1)}mm</span>
                                    <span className={`font-medium ${mine > 0 ? 'text-blue-600' : 'text-slate-400'}`}>{mine > 0 ? mine.toFixed(1)+'mm' : '-'}</span>
                                    <span className={`font-bold ${diff > 2 ? 'text-red-500' : diff < -2 ? 'text-green-600' : 'text-slate-400'}`}>
                                        {mine > 0 ? (diff > 0 ? '+' : '') + diff.toFixed(1) : '-'}
                                    </span>
                                </div>
                            );
                        })}
                    </div>
                    <p className="text-xs text-slate-400 text-center">Azul = dias com seus registros ¬∑ Diff = Seu valor ‚àí API</p>
                </div>
            </Modal>
        );
    };

    // ============ MAIN RENDER ============
    return (
        <div className="flex min-h-screen bg-slate-100 font-sans text-slate-900 flex-col md:flex-row">
            {menuOpen && <div className="fixed inset-0 bg-black/50 z-20 md:hidden" onClick={()=>setMenuOpen(false)}/>}
            {renderSidebar()}
            <div className="flex-1 flex flex-col min-h-0 overflow-hidden">
                <header className="md:hidden bg-white border-b p-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
                    <h1 className="font-bold flex items-center gap-2 text-slate-800"><CloudRain className="text-blue-500" size={20}/>Pluvi√¥metro Digital</h1>
                    <button onClick={()=>setMenuOpen(true)} className="p-1.5 hover:bg-slate-100 rounded-lg"><Menu size={20}/></button>
                </header>
                <main className="flex-1 overflow-y-auto p-4 max-w-2xl mx-auto w-full">
                    {view === 'dashboard' && renderDashboard()}
                    {view === 'entry' && renderEntry()}
                    {view === 'reports' && renderReports()}
                    {view === 'tools' && renderTools()}
                    {view === 'settings' && renderSettings()}
                </main>
            </div>

            {/* Bottom Nav (mobile) */}
            <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-lg z-10 flex">
                {[
                    {id:'dashboard', icon:BarChart3, label:'In√≠cio'},
                    {id:'entry', icon:Save, label:'Registrar'},
                    {id:'reports', icon:History, label:'Registros'},
                    {id:'tools', icon:Database, label:'Ferramentas'},
                    {id:'settings', icon:MapPin, label:'Config'},
                ].map(item => (
                    <button key={item.id} onClick={()=>navTo(item.id)} className={`flex-1 flex flex-col items-center py-2.5 gap-0.5 transition-colors ${view===item.id ? 'text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}>
                        <item.icon size={20}/>
                        <span className="text-[10px] font-medium">{item.label}</span>
                    </button>
                ))}
            </div>

            {/* Modais */}
            {renderImportModal()}
            {renderExportModal()}
            {renderReportModal()}
            {renderBackupModal()}
            {renderClimateModal()}

            {/* Toast */}
            <Toast message={toast.message} visible={toast.visible}/>
        </div>
    );
}

const root = createRoot(document.getElementById('root'));
root.render(<App/>);
</script>

<script>
  // Registra o Service Worker para PWA instal√°vel + offline
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('./sw.js')
        .then(function(reg) {
          console.log('[PWA] Service Worker registrado:', reg.scope);

          // Detecta nova vers√£o dispon√≠vel
          reg.addEventListener('updatefound', function() {
            var newWorker = reg.installing;
            newWorker.addEventListener('statechange', function() {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // Notifica o usu√°rio que h√° atualiza√ß√£o
                if (confirm('Nova vers√£o dispon√≠vel! Atualizar agora?')) {
                  newWorker.postMessage({ type: 'SKIP_WAITING' });
                  window.location.reload();
                }
              }
            });
          });
        })
        .catch(function(err) {
          console.warn('[PWA] Erro ao registrar SW:', err);
        });
    });
  }
</script>
</body>
</html>
